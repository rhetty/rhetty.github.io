<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="程序猿二三事">
<meta property="og:type" content="website">
<meta property="og:title" content="正宫阁">
<meta property="og:url" content="http://rhetty.github.io/index.html">
<meta property="og:site_name" content="正宫阁">
<meta property="og:description" content="程序猿二三事">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="正宫阁">
<meta name="twitter:description" content="程序猿二三事">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://rhetty.github.io/"/>

  <title> 正宫阁 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">正宫阁</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">随便BB</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/21/复习一下排序算法/" itemprop="url">
                  复习一下排序算法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-01-21T14:28:29+08:00" content="2017-01-21">
              2017-01-21
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/01/21/复习一下排序算法/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/21/复习一下排序算法/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="桶排序"><a href="#桶排序" class="headerlink" title="桶排序"></a>桶排序</h1><h2 id="简化版"><a href="#简化版" class="headerlink" title="简化版"></a>简化版</h2><p>假如有一个考试，满分10分。有5个同学分别考了5分、3分、5分、2分和8分，需要将分数进行排序。</p>
<p>首先需要申请一个大小为11的数组int a[11]，将a[0]~a[10]都初始化为0，表示这些分数还都没有人得过。例如，a[0]等于0就表示目前还没有人得过0分……</p>
<p>第一个人的分数是5分，就将相对应的a[5]的值在原来的基础上增加1，即a[5]=1，表示5分出现过了一次。第二个人的分数是3分，则a[3]=1。第三个人也是5分，因此这时a[5]=2。依次处理完所有分数。</p>
<p>最后再依次打印11个桶，没有出现过就不打印，出现了几次就打印几次。如从前往后打印，则最终输出“2 3 5 5 8”。代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> a[<span class="number">11</span>], i, j, t;</div><div class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= <span class="number">10</span>; i++)</div><div class="line">    a[i] = <span class="number">0</span>; <span class="comment">// 初始化为0</span></div><div class="line">  </div><div class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= <span class="number">5</span>; i++) <span class="comment">// 循环读入5个数</span></div><div class="line">  &#123;</div><div class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;t);</div><div class="line">    a[t]++;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= <span class="number">10</span>; i++) <span class="comment">// 依次判断</span></div><div class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; a[i]; j++) <span class="comment">// 出现了几次就打印几次</span></div><div class="line">      <span class="built_in">printf</span>(<span class="string">"%d "</span>, i);</div><div class="line">      </div><div class="line">  getchar(); getchar();</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个算法的时间复杂度为O(M+N)，M为桶的个数，N为数的个数。这个算法是非常快的，但是，如果要求在对分数进行排序输出的同时，输出对应学生的名字，这个算法就无法做到。此外，如果待排序数的跨度非常大而数很少，那会导致浪费很多的桶。</p>
<h2 id="标准版"><a href="#标准版" class="headerlink" title="标准版"></a>标准版</h2><p>标准的桶排序也是将数据表分割成多个桶，但是每个桶中可以放一个区间内的数据，而不只是一个单一的值。然后每个桶内再各自排序，可以用不同的排序算法，或者递归的使用桶排序，这是典型的分治策略。</p>
<p>基本流程：</p>
<ol>
<li>建立一堆桶</li>
<li>遍历原始数据，并将数据放到各自的桶中</li>
<li>对非空的桶进行排序</li>
<li>按照顺序遍历这些桶并放回到原始数组中即可构成排序后的数组</li>
</ol>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUCKET_COUNT = <span class="number">10</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bucketSort</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</div><div class="line">	List buckets = <span class="keyword">new</span> ArrayList&lt;ArrayList&lt;Integer&gt;&gt;();</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; BUCKET_COUNT; i++) &#123;</div><div class="line">		buckets.add(<span class="keyword">new</span> ArrayList());</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;</div><div class="line">		<span class="keyword">int</span> idx = array[i] / BUCKET_COUNT; <span class="comment">// 将每个数据分配到对应的桶中</span></div><div class="line">		buckets.get(idx).add(array[i]);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> (List bucket : buckets) &#123;</div><div class="line">		Collections.sort(bucket); <span class="comment">// 对每个桶进行排序</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> (List bucket : buckets) &#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> a : bucket) &#123;</div><div class="line">			System.out.println(a);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>桶排序的时间复杂度主要依赖于桶内比较排序算法的复杂度，最快为O(N*logN)。显然，可以通过减少桶内数据的数量来提高排序效率，因此可以：</p>
<ul>
<li>尽量将数据平均分配到各个桶中</li>
<li>增加桶的数量，当达到极限情况，即每个桶内只有一个数据时，就是上面提到的简化版桶排序，这时的时间复杂度可以达到O(N)。但是这样会导致空间浪费严重。</li>
</ul>
<h1 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h1><p>冒泡排序是最直接的排序算法了，基本思想是：<strong>每次比较两个相邻的元素，如果它们的顺序错误就把它们交换位置</strong>。</p>
<p>直接上代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bubbleSort</span><span class="params">(AnyType[] array)</span> </span>&#123;</div><div class="line">  <span class="keyword">int</span> tmp = <span class="number">0</span>;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = array.length - <span class="number">1</span>; i &gt; <span class="number">0</span>; --i) &#123;</div><div class="line">  	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; i; ++j) &#123;</div><div class="line">  		<span class="keyword">if</span> (array[j].compareTo(array[j+<span class="number">1</span>]) &gt; <span class="number">0</span>) &#123;</div><div class="line">  			tmp = array[j];</div><div class="line">  			array[j] = array[j+<span class="number">1</span>];</div><div class="line">  			array[j+<span class="number">1</span>] = tmp;</div><div class="line">  		&#125;</div><div class="line">  	&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>冒泡排序的时间复杂度为O(N*N)，比较慢，并且冒泡排序是稳定的。</p>
<h1 id="插入排序"><a href="#插入排序" class="headerlink" title="插入排序"></a>插入排序</h1><p>插入排序是最简单的排序算法之一。插入排序由N-1趟排序组成，对于p=1到N-1趟，每次都基于前面位置0到p-1上的元素已经排好序，将位置p的元素向前移动，插入到合适的位置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">insertionSort</span><span class="params">(AnyType[] a)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> j;</div><div class="line">  </div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">1</span>; p &lt; a.length; ++p) &#123;</div><div class="line">    AnyType tmp = a[p];</div><div class="line">    <span class="keyword">for</span> (j = p; j &gt; <span class="number">0</span> &amp;&amp; tmp.compareTo(a[j-<span class="number">1</span>]) &lt; <span class="number">0</span>; --j)</div><div class="line">      a[j] = a[j-<span class="number">1</span>];</div><div class="line">    a[j] = tmp;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>插入排序的平均时间复杂度为O(N^2)。如果输入数据已预先排序，那么时间花费为O(N)，或者数据几乎被排序过，那插入排序也很快。插入排序是一种稳定的排序算法。</p>
<h1 id="希尔排序"><a href="#希尔排序" class="headerlink" title="希尔排序"></a>希尔排序</h1><p>希尔排序通过比较相距一定间隔的元素来工作，各趟比较所用的距离随着算法的进行而减小，直到只比较相邻的元素的最后一趟排序为止。因此，希尔排序有时也叫<strong>缩减增量排序</strong>。</p>
<p>希尔排序使用一个序列$h_1, h_2,\dots,h_t$，叫做<strong>增量序列</strong>。只要$h_1=1$，任何增量序列都是可行的，但是不同的增量序列对排序效率有所影响。每一趟对间隔为$h_k$的元素进行一次插入排序。</p>
<p>增量序列的一个流行（但是不好）的选择是使用Shell建议的序列：$h_t=\lfloor N/2\rfloor$和$h<em>k=\lfloor h</em>{k+1}/2\rfloor$。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shellSort</span><span class="params">(AnyType[] a)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> j;</div><div class="line">  </div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> gap = a.length/<span class="number">2</span>; gap &gt; <span class="number">0</span>; gap /= <span class="number">2</span>)</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = gap; i &lt; a.length; ++i)</div><div class="line">    &#123;</div><div class="line">      AnyType tmp = a[i];</div><div class="line">      <span class="keyword">for</span> (j = i; j &gt;= gap &amp;&amp; tmp.compareTo(a[j - gap]) &lt; <span class="number">0</span>; j -= gap)</div><div class="line">        a[j] = a[j - gap];</div><div class="line">      a[j] = tmp;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>希尔排序的运行时间依赖于增量序列的选择，证明起来非常复杂。希尔排序的平均情形分析，除最平凡的一些增量序列外，是一个长期未解决的问题。使用希尔增量时希尔排序的最坏情形运行时间为O(N^2)。使用Hibbard增量的希尔排序的最坏情形运行时间为$O(N^{3/2})$。</p>
<h1 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h1><p>快速排序应该是最常用的排序算法了，它的基本思想是：<strong>待排序数据中选择一个基准数（有的书上称为枢纽元（pivot）），将比它小的数放到它的左边，比它大的数放到它的右边，再递归处理两边的数据，直到排序结束</strong>。</p>
<h2 id="选取枢纽元"><a href="#选取枢纽元" class="headerlink" title="选取枢纽元"></a>选取枢纽元</h2><p>选择合适的枢纽元直接影响排序的效率。</p>
<h3 id="错误做法"><a href="#错误做法" class="headerlink" title="错误做法"></a>错误做法</h3><p>一种通常的做法是选择第一个元素作为枢纽元。如果输入是随机的，那么这是可以接受的。但是如果输入是预排序或是反序的，那就可能导致所有的元素都被划入枢纽元的左边或右边，而且这在所有的递归中都会发生，这样排序的时间花费将是二次的。另一种想法是选取前两个互异的元素中的较大者作为枢纽元，不过这与只选取第一个元素作为枢纽元具有相同的害处。</p>
<h3 id="安全做法"><a href="#安全做法" class="headerlink" title="安全做法"></a>安全做法</h3><p>一种安全做法是随机选取枢纽元，一般来说这是安全的，除非随机数产生器有问题。然而，随机数的生成一般开销很大。</p>
<h3 id="三数中值分割法"><a href="#三数中值分割法" class="headerlink" title="三数中值分割法"></a>三数中值分割法</h3><p>显然，枢纽元最好的选择是数组的中值，但是计算中值比较困难而且会影响排序的速度。中值的估算量可以通过随机选取三个元素并用它们的中值作为枢纽元，事实上，随机选取帮助不大，一般可以使用左端、右端和中心位置上的三个元素的中值作为枢纽元。</p>
<h2 id="分割策略"><a href="#分割策略" class="headerlink" title="分割策略"></a>分割策略</h2><p>分割的第一步是将枢纽元与最后的元素交换使得枢纽元离开要被分割的数据段。i从第一个元素开始向右移过所有小元素，j从倒数第二个元素开始向左移过所有大元素，然后将i、j互换，直到i、j交错。最后再将枢纽元与i交换。</p>
<p>一个重要的问题是如何处理等于枢纽元的元素，即i或j遇到一个等于枢纽元的元素时是否应该停止。</p>
<p>考虑数组中所有的元素都相等的情况。如果i和j都停止，那么过程中有很多次交换，最终建立了两个几乎相等的子数组，因此运行时间为O(N*logN)。</p>
<p>如果i和j都不停止，那么就应该防止i和j越过数组的端点。而且，最终枢纽元与i交换位置，此时i会在最左端或最右端，这样就会产生两个非常不均衡的子数组。那么运行时间将是O(N*N)。</p>
<p>因此，进行不必要的交换建立两个均衡的子数组要比蛮干冒险得到两个不均衡的子数组好。</p>
<h2 id="小数组"><a href="#小数组" class="headerlink" title="小数组"></a>小数组</h2><p>对于很小的数组（N&lt;=20），快速排序不如插入排序。</p>
<h2 id="代码实例"><a href="#代码实例" class="headerlink" title="代码实例"></a>代码实例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">quickSort</span><span class="params">(AnyType[] a, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span>(left + CUTOFF &lt;= right)</div><div class="line">  &#123;</div><div class="line">    AnyType pivot = median3(a, left, right);</div><div class="line">    </div><div class="line">    <span class="keyword">int</span> i = left, j = right - <span class="number">1</span>;</div><div class="line">    <span class="keyword">for</span>( ; ; )</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">while</span>(a[++i].compareTo(pivot) &lt; <span class="number">0</span>) &#123;&#125;</div><div class="line">      <span class="keyword">while</span>(a[--j].compareTo(pivot) &gt; <span class="number">0</span>) &#123;&#125;</div><div class="line">      <span class="keyword">if</span>(i &lt; j)</div><div class="line">        swapReferences(a, i, j);</div><div class="line">      <span class="keyword">else</span></div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    swapReferences(a, i, right - <span class="number">1</span>);</div><div class="line">    </div><div class="line">    quickSort(a, left, i - <span class="number">1</span>);</div><div class="line">    quickSort(a, i + <span class="number">1</span>, right);</div><div class="line">  &#125; <span class="keyword">else</span> </div><div class="line">    insertionSort(a, left, right);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> AnyType <span class="title">median3</span><span class="params">(AnyType[] a, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> center = (left + right) / <span class="number">2</span>;</div><div class="line">  <span class="keyword">if</span>(a[center].compareTo(a[left]) &lt; <span class="number">0</span>)</div><div class="line">    swapReferences(a, left, center);</div><div class="line">  <span class="keyword">if</span>(a[right].compareTo(a[left]) &lt; <span class="number">0</span>)</div><div class="line">    swapReferences(a, left, right);</div><div class="line">  <span class="keyword">if</span>(a[right].compareTo(a[center]) &lt; <span class="number">0</span>)</div><div class="line">    swapReferences(a, center, right);</div><div class="line">    </div><div class="line">  swapReferences(a, center, right - <span class="number">1</span>);</div><div class="line">  <span class="keyword">return</span> a[right - <span class="number">1</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述方法执行三数中值分割法，先将三数进行了排序，然后将right-1位置上的数作为枢纽元。这个方法的额外好处就是，left和right位置上的数已经放在了正确的位置。</p>
<h2 id="算法分析"><a href="#算法分析" class="headerlink" title="算法分析"></a>算法分析</h2><p>快速排序时间花费的最坏情况是O(N^2)，最好情况是O(N*logN)，平均情况也是O(N*logN)。快速排序是不稳定的。</p>
<h1 id="堆排序"><a href="#堆排序" class="headerlink" title="堆排序"></a>堆排序</h1><p>使用堆排序，首先需要建立一个<strong>二叉堆</strong>。这时最小的元素就会在堆顶，每次执行deleteMin操作，最小的元素先离开堆，通过将这些元素依次记录到另一个数组中，得到N个元素的排序。</p>
<p>但是，这样的方法就使用了一个附加的数组。因此，存储需求增加一倍。为了回避这个问题，可以这么做：每次deleteMin之后，堆减小1。因此，位于堆中最后的单元可以用来存放刚刚删去的元素。使用这种策略时，最后该数组会保存一个倒序的排序，所以如果想进行典型的递增排序，一开始应建立最大堆。</p>
<p>在实现中，通过每次将堆中的最后元素与第一个元素交换，执行N-1次deleteMax操作，每次将堆的大小缩减1并进行下滤。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">leftChild</span><span class="params">(<span class="keyword">int</span> i)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> <span class="number">2</span> * i + <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">percDown</span><span class="params">(AnyType[] a, <span class="keyword">int</span> i, <span class="keyword">int</span> n)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> child;</div><div class="line">	AnyType tmp;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (tmp = a[i]; leftChild(i) &lt; n; i = child) &#123;</div><div class="line">		child = leftChild(i);</div><div class="line">		<span class="keyword">if</span> (child != n - <span class="number">1</span> &amp;&amp; a[child].compareTo(a[child + <span class="number">1</span>]) &lt; <span class="number">0</span>)</div><div class="line">			child++;</div><div class="line">		<span class="keyword">if</span> (tmp.compareTo(a[child]) &lt; <span class="number">0</span>)</div><div class="line">			a[i] = a[child];</div><div class="line">		<span class="keyword">else</span></div><div class="line">			<span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	a[i] = tmp;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">heapSort</span><span class="params">(AnyType[] a)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = a.length / <span class="number">2</span>; i &gt;= <span class="number">0</span>; i--) &#123;	<span class="comment">/* buildHeap */</span></div><div class="line">		percDown(a, i, a.length);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = a.length - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</div><div class="line">		swapReferences(a, <span class="number">0</span>, i);				<span class="comment">/* deleteMax */</span></div><div class="line">		percDown(a, <span class="number">0</span>, i);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>建立二叉堆的时间花费为O(N)，然后执行N次deleteMax操作，每个deleteMax花费时间O(logN)，因此总的运行时间为O(NlogN)。堆排序是不稳定的。</p>
<h1 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h1><p>归并排序的基本操作是合并两个已排序的表。基本的合并算法是取两个输入数组A和B，一个输出数组C，以及3个计数器Actr、Bctr、Cctr，它们初始置于对应数组的开始端。A[Actr]和B[Bctr]中的较小者被拷贝到C中的下一个位置，相关的计数器向前推进一步。当两个输入表有一个用完的时候，则将另一个表中的剩余部分拷贝到C中。</p>
<p>对merge例程的设计比较关键，如果对merge的每个递归调用均局部声明一个临时数组，那么在任一时刻就可能有logN个临时数组处在活动期（为什么呢。。merge本身并没有递归，似乎只有创建临时数组会浪费一些时间。。）。由于merge是mergeSort的最后一行，因此在任一时刻只需要一个临时数组在活动，而且这个临时数组可以在public型的mergeSort驱动程序中建立。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(AnyType[] a, AnyType[] tmpArray, <span class="keyword">int</span> leftPos, <span class="keyword">int</span> rightPos, <span class="keyword">int</span> rightEnd)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> leftEnd = rightPos - <span class="number">1</span>;</div><div class="line">	<span class="keyword">int</span> tmpPos = leftPos;</div><div class="line">	<span class="keyword">int</span> numElements = rightEnd - leftPos + <span class="number">1</span>;</div><div class="line"></div><div class="line">	<span class="keyword">while</span>(leftPos &lt;= leftEnd &amp;&amp; rightPos &lt;= rightEnd)</div><div class="line">		<span class="keyword">if</span> (a[leftPos].compareTo(a[rightPos]) &lt;= <span class="number">0</span>)</div><div class="line">			tmpArray[tmpPos++] = a[leftPos++];</div><div class="line">		<span class="keyword">else</span></div><div class="line">			tmpArray[tmpPos++] = a[rightPos++];</div><div class="line"></div><div class="line">	<span class="keyword">while</span>(leftPos &lt;= leftEnd) <span class="comment">// Copy rest of first half</span></div><div class="line">		tmpArray[tmpPos++] = a[leftPos++];</div><div class="line"></div><div class="line">	<span class="keyword">while</span>(rightPos &lt;= rightEnd) <span class="comment">// Copy rest of the right half</span></div><div class="line">		tmpArray[tmpPos++] = a[rightPos++];</div><div class="line"></div><div class="line">	<span class="comment">// Copy tmpArray back</span></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numElements; i++, rightEnd--) &#123;</div><div class="line">		a[rightEnd] = tmpArray[rightEnd];</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mergeSort</span><span class="params">(AnyType[] a, AnyType[] tmpArray, <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (left &lt; right) &#123;</div><div class="line">		<span class="keyword">int</span> center = (left + right) / <span class="number">2</span>;</div><div class="line">		mergeSort(a, tmpArray, left, center);</div><div class="line">		mergeSort(a, tmpArray, center + <span class="number">1</span>, right);</div><div class="line">		merge(a, tmpArray, left, center + <span class="number">1</span>, right);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mergeSort</span><span class="params">(AnyType[] a)</span></span></div><div class="line">&#123;</div><div class="line">	AnyType[] tmpArray = (AnyType[])<span class="keyword">new</span> Comparable[a.length];</div><div class="line">	mergeSort(a, tmpArray, <span class="number">0</span>, a.length - <span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>归并排序的运行时间是O(NlogN)，但是它由一些附加消耗，如拷贝临时数组等。归并排序是稳定的。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li>《数据结构与算法分析——Java语言描述》第2版</li>
<li>《啊哈！算法》</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/27/【翻译】Mock不是Stub/" itemprop="url">
                  【翻译】Mock不是Stub
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-27T20:31:16+08:00" content="2016-10-27">
              2016-10-27
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/27/【翻译】Mock不是Stub/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/27/【翻译】Mock不是Stub/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在测试中，“mock对象”常被用来描述模仿真实对象的特殊对象。现在，大部分语言环境提供了便于创建mock对象的框架。然而常被忽视的是，mock对象不只是一种用来测试的特殊对象，它还代表了一种不同的测试风格。在本文中，我将解释mock是如何工作、它们如何进行基于行为验证的测试，以及相关社区如何开发出一种不同的测试风格。</p>
<p>一年前，在极限编程（XP）社区里我第一次看到“mock”这个词。从此我越来越多的看到关于mock的东西。部分原因是，mock对象的许多主要开发者变成了我在ThoughtWorks的同事；另一个原因是，我在XP测试相关的文献里看到越来越多这方面的内容。</p>
<p>然而，我时常看到对mock的定义是很不充分的。尤其是我发现它经常与stub搞混——一种测试环境下常用的工具。我十分理解这种误解——有一段时间我也觉得它们很相似，但是与mock开发者交流之后，我对mock的理解逐渐明晰。</p>
<p>它们主要有两点不同。<strong><em>一是测试结果验证方式的不同：状态验证与行为验证的区别；二是测试方式与设计整个测试理念的不同，我把它看作测试驱动开发（TDD）中一般的和mock式的两种测试风格。</em></strong></p>
<h1 id="普通测试"><a href="#普通测试" class="headerlink" title="普通测试"></a>普通测试</h1><p>首先，我用一个简单的例子说明这两种风格。（例子是用Java写的，但其中的原理对所有面向对象语言都适用。）我们想产生一个订单对象，然后通过一个仓库对象填写它。订单非常简单，只有产品和数量。仓库持有不同产品的清单。当我们想填写一个订单时，有两种可能的结果。如果仓库中有足够的产品，订单就正常填写，并且仓库中该产品的数量将相应减少。如果仓库中没有足够的产品，那么订单无法填写，仓库也没有任何改变。</p>
<p>这两种行为引出一组测试，这些代码就跟传统的JUnit测试一样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderStateTester</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String TALISKER = <span class="string">"Talisker"</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String HIGHLAND_PARK = <span class="string">"Highland Park"</span>;</div><div class="line">  <span class="keyword">private</span> Warehouse warehouse = <span class="keyword">new</span> WarehouseImpl();</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    warehouse.add(TALISKER, <span class="number">50</span>);</div><div class="line">    warehouse.add(HIGHLAND_PARK, <span class="number">25</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOrderIsFilledIfEnoughInWarehouse</span><span class="params">()</span> </span>&#123;</div><div class="line">    Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">50</span>);</div><div class="line">    order.fill(warehouse);</div><div class="line">    assertTrue(order.isFilled());</div><div class="line">    assertEquals(<span class="number">0</span>, warehouse.getInventory(TALISKER));</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOrderDoesNotRemoveIfNotEnough</span><span class="params">()</span> </span>&#123;</div><div class="line">    Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">51</span>);</div><div class="line">    order.fill(warehouse);</div><div class="line">    assertFalse(order.isFilled());</div><div class="line">    assertEquals(<span class="number">50</span>, warehouse.getInventory(TALISKER));</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>xUnit测试遵循典型的4个阶段：setup、exercise、verify、teardown。在这个例子中，setup阶段部分是在<code>setUp</code>方法里完成（设置仓库），部分在测试方法中（设置订单)。<code>order.fill</code>的调用是在exercise阶段，这就是对象被触发去做我们想要测试的东西的地方。接着断言语句就是验证阶段，检查被调用方法是否正确执行了它的任务。在这个例子中没有明确的teardown阶段，垃圾回收器会帮我们做完。</p>
<p>在setup中，我们把两种对象放在一起。Order是我们要测试的类，但是为了能够调用<code>Order.fill</code>，我们还需要Warehouse的实例。这种情况下，Order是我们专注测试的对象，测试人员倾向于使用object-under-test或system-under-test来命名这类东西。这两个词都很拗口，但它们都被广泛接受，那我就勉为其难用一下。为了追随Meszaros，我就用System Under Test，或者缩写SUT。</p>
<p>所以这个测试中我需要SUT（Order）和一个合作者（warehouse）。我需要warehouse有两个原因：一是为了让被测试行为能工作（因为<code>Order.fill</code>调用了warehouse的方法），二是要用它来验证（因为<code>Order.fill</code>的结果之一是潜在改变了warehouse的状态）。随着我们对这个话题的探索，你将看到我们发现在SUT和合作者之间的许多区别。（在这篇文章的早些版本中，我把SUT称作”主要对象“，把合作者称为”次要对象“）</p>
<p>这类测试使用了<strong><em>状态验证</em></strong>：我们通过在方法调用后，检查SUT和它的合作者的状态，来判断被测试方法是否正确的执行了。我们将看到，通过mock对象能够使用不同的验证方法。</p>
<h1 id="使用mock测试"><a href="#使用mock测试" class="headerlink" title="使用mock测试"></a>使用mock测试</h1><p>现在，我们将做相同的工作，并且使用mock对象。在代码中，我用的是<strong><em>jMock</em></strong>库来定义mock。jMock是一个java mock对象库。还有其他的mock对象库，但这是一个与时俱进的库，它由这项技术的发起人编写，所以还是不错的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderInteractionTester</span> <span class="keyword">extends</span> <span class="title">MockObjectTestCase</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String TALISKER = <span class="string">"Talisker"</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFillingRemovesInventoryIfInStock</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//setup - data</span></div><div class="line">    Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">50</span>);</div><div class="line">    Mock warehouseMock = <span class="keyword">new</span> Mock(Warehouse.class);</div><div class="line">    </div><div class="line">    <span class="comment">//setup - expectations</span></div><div class="line">    warehouseMock.expects(once()).method(<span class="string">"hasInventory"</span>)</div><div class="line">      .with(eq(TALISKER),eq(<span class="number">50</span>))</div><div class="line">      .will(returnValue(<span class="keyword">true</span>));</div><div class="line">    warehouseMock.expects(once()).method(<span class="string">"remove"</span>)</div><div class="line">      .with(eq(TALISKER), eq(<span class="number">50</span>))</div><div class="line">      .after(<span class="string">"hasInventory"</span>);</div><div class="line"></div><div class="line">    <span class="comment">//exercise</span></div><div class="line">    order.fill((Warehouse) warehouseMock.proxy());</div><div class="line">    </div><div class="line">    <span class="comment">//verify</span></div><div class="line">    warehouseMock.verify();</div><div class="line">    assertTrue(order.isFilled());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFillingDoesNotRemoveIfNotEnoughInStock</span><span class="params">()</span> </span>&#123;</div><div class="line">    Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">51</span>);    </div><div class="line">    Mock warehouse = mock(Warehouse.class);</div><div class="line">      </div><div class="line">    warehouse.expects(once()).method(<span class="string">"hasInventory"</span>)</div><div class="line">      .withAnyArguments()</div><div class="line">      .will(returnValue(<span class="keyword">false</span>));</div><div class="line"></div><div class="line">    order.fill((Warehouse) warehouse.proxy());</div><div class="line"></div><div class="line">    assertFalse(order.isFilled());</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>首先关注<code>testFillingRemovesInventoryIfInStock</code>，因为我在后面的测试中省略了很多。</p>
<p>首先，setup阶段就不太一样。它被分为两部分：数据和期望。数据部分建立了我们关注的对象，它与传统的setup相似。不同之处在于所创建的对象。SUT是一样的——一个订单。但合作者不是一个仓库对象，而是一个mock仓库——准确来说是一个Mock类的实例。</p>
<p>setup的第二部分创建了针对mock对象的期望。期望指出了当SUT被操作时，mock应该被调用的方法。</p>
<p>一旦所有的期望都就绪了，就操作SUT。操作之后进行验证，验证包含两个方面。针对SUT执行断言——跟之前一样。但我还验证了mock——检查它是否符合期望被调用了。</p>
<p>这里最关键的不同之处在于，我们是如何验证订单在与仓库交互中是行为正确的。在状态验证中我们通过断言仓库的状态。而mock使用行为验证，我们需要检查订单是否正确调用了仓库。我们通过在setup阶段设置mock的期望，并让mock在验证阶段验证自身。只有订单用断言来检查，并且如果被测试方法没有改变订单状态，那就不会有断言。</p>
<p>在第二个测试中我作了一些改变。首先我用不同的方式创建了mock，没有用构造方法，而用了<code>MockObjectTestCase</code>的<code>mock</code>方法。它是jMock库中一个很方便的方法，这样我就不需要在之后显式调用验证方法，用这种方法构造的mock都会在测试的最后自动进行验证。在第一个测试中也可以这么用，但我想更清楚地展示用mock测试时验证的方法。</p>
<p>第二个测试中另一个不同点是我用<code>withAnyArguments</code>松化了期望的约束。因为第一个测试检查了传给仓库的数量参数，所以第二个测试不用重复这样做。如果之后订单的逻辑改变了，那么只有一个测试会不通过，这样便于测试代码的维护。由于<code>withAnyArguments</code>是缺省的方式，我也可以把它们都省略掉。</p>
<h2 id="使用EasyMock"><a href="#使用EasyMock" class="headerlink" title="使用EasyMock"></a>使用EasyMock</h2><p>在众多mock对象库中，我用的比较多的是<strong><em>EasyMock</em></strong>，它有java和.NET版本。EasyMock同样支持行为验证，但和jMock有一些差别。下面是一些熟悉的测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderEasyTester</span> <span class="keyword">extends</span> <span class="title">TestCase</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String TALISKER = <span class="string">"Talisker"</span>;</div><div class="line">  </div><div class="line">  <span class="keyword">private</span> MockControl warehouseControl;</div><div class="line">  <span class="keyword">private</span> Warehouse warehouseMock;</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</div><div class="line">    warehouseControl = MockControl.createControl(Warehouse.class);</div><div class="line">    warehouseMock = (Warehouse) warehouseControl.getMock();    </div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFillingRemovesInventoryIfInStock</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//setup - data</span></div><div class="line">    Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">50</span>);</div><div class="line">    </div><div class="line">    <span class="comment">//setup - expectations</span></div><div class="line">    warehouseMock.hasInventory(TALISKER, <span class="number">50</span>);</div><div class="line">    warehouseControl.setReturnValue(<span class="keyword">true</span>);</div><div class="line">    warehouseMock.remove(TALISKER, <span class="number">50</span>);</div><div class="line">    warehouseControl.replay();</div><div class="line"></div><div class="line">    <span class="comment">//exercise</span></div><div class="line">    order.fill(warehouseMock);</div><div class="line">    </div><div class="line">    <span class="comment">//verify</span></div><div class="line">    warehouseControl.verify();</div><div class="line">    assertTrue(order.isFilled());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFillingDoesNotRemoveIfNotEnoughInStock</span><span class="params">()</span> </span>&#123;</div><div class="line">    Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">51</span>);    </div><div class="line"></div><div class="line">    warehouseMock.hasInventory(TALISKER, <span class="number">51</span>);</div><div class="line">    warehouseControl.setReturnValue(<span class="keyword">false</span>);</div><div class="line">    warehouseControl.replay();</div><div class="line"></div><div class="line">    order.fill((Warehouse) warehouseMock);</div><div class="line"></div><div class="line">    assertFalse(order.isFilled());</div><div class="line">    warehouseControl.verify();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>EasyMock使用类似录制/回放的方式来设置期望。对于每个想要进行mock的对象，分别创建一个control对象和mock对象。mock实现次要对象的接口，control则提供附加的功能。通过调用mock的方法，指明正确的参数，来说明期望。想要返回值的话，可以调用control的方法。当你设置完期望后，就可以调用control的回放——这时mock完成了录制，可以与主要对象交互了。都完成之后就可以调用control的验证方法。</p>
<p>似乎人们一开始常对录制/回放感到困扰，但事实上他们能很快习惯。与jMock的约束相比，它有一个优点在于，你可以调用真实的方法，而不是用字符串书写方法名。这样你就可以使用IDE的自动补全功能，而且修改方法名时也可以自动更新测试。缺点是你不能用宽松的约束。</p>
<p>jMock的开发者正在开发一个新版本，它将使用另一种技术来调用真实的方法。</p>
<h1 id="Mock与Stub的不同"><a href="#Mock与Stub的不同" class="headerlink" title="Mock与Stub的不同"></a>Mock与Stub的不同</h1><p>当它们第一次面世时，许多人将mock与使用stub的一般测试概念搞混。之后似乎人们开始理解了它们之间的不同（我希望是本文早些版本的功劳）。但是为了全面理解使用mock的方式，学习mock和其他测试doubles是很关键的。（”doubles“？不懂也不用担心，再看几段就明白了）</p>
<p>当你像这样进行测试时，某一时刻你只关注软件中的一个元素——就是常说的单元测试。问题是，为了完成一个单一的功能，常常还需要其他单元——在我们的例子中就需要仓库。</p>
<p>在上面两种我展示的测试类型中，第一个例子使用了真实的仓库对象，而第二个例子用了一个仓库的mock，它不是一个真实的仓库对象。在这个测试中，使用mock是避免用真实仓库的一种方式，也可以用其他形式的非真实对象。</p>
<p>要讨论的词汇有点混乱了——用到了各种词：stub、mock、fake、dummy。在本文中，我会依据<strong><em>Gerard Meszaros</em></strong>的书的词汇表。虽然不是很常用，但我觉得还不错，而且这是我的文章，我来选择用词。</p>
<p>Meszaros使用<strong><em>测试Double</em></strong>这个术语来描述测试中代替真实对象存在的所有虚假的对象。这个名字来源于电影中的特技替身演员的概念。（他的目的之一是避免使用其他被广泛使用的名字）。Meszaros定义了4类double：</p>
<ul>
<li>Dummy对象用来传递但从不被使用，通常它们用来填补参数列表。</li>
<li>Fake对象是实现功能的，但通常它们有一些缺陷，不适合在最终产品中。（内存数据库是一个不错的例子）</li>
<li>Stub针对测试中的调用提供了固定的回复，通常不回应测试之外的调用。stub也可能记录调用的信息，例如email网关的stub会记录它所”发送“的消息，或者是它”发送“消息的数量。</li>
<li>Mock就是我们正在讨论的东西：针对对象预先指定期望，它规定了方法应当如何被调用。</li>
</ul>
<p>在这些类型的double中，只有mock基于行为验证。其他double能够，且通常使用状态验证。mock在exercise阶段确实与其他double很相似，因为它们需要让SUT认为正在与真实的合作者交互——但mock在setup阶段和验证阶段是与其他double不同的。</p>
<p>为了进一步探究double，我们需要扩展我们的例子。许多人只有在真实对象很难用时才会用double。一个针对double更常用的例子是，如果订单填写失败，就需要发送一封email。问题在于在测试中我们并不想真的发送一封email给客户。所以我们创建一个email系统的double，我们可以更好的控制它。</p>
<p>在这里我们可以看到mock和stub的不同。如果我们在写一个针对邮寄的测试，我们可能像这样写一个简单的stub。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MailService</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span> <span class="params">(Message msg)</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MailServiceStub</span> <span class="keyword">implements</span> <span class="title">MailService</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> List&lt;Message&gt; messages = <span class="keyword">new</span> ArrayList&lt;Message&gt;();</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span> <span class="params">(Message msg)</span> </span>&#123;</div><div class="line">    messages.add(msg);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numberSent</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> messages.size();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后我们可以这样对stub进行状态验证。</p>
<p><strong><em>class OrderStateTester…</em></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOrderSendsMailIfUnfilled</span><span class="params">()</span> </span>&#123;</div><div class="line">  Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">51</span>);</div><div class="line">  MailServiceStub mailer = <span class="keyword">new</span> MailServiceStub();</div><div class="line">  order.setMailer(mailer);</div><div class="line">  order.fill(warehouse);</div><div class="line">  assertEquals(<span class="number">1</span>, mailer.numberSent());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然这是一个非常简单的测试——只有一个消息被发送了。我们并没有测试它是否发送给了正确的人，或内容正确，但这可以说明要点了。</p>
<p>使用mock的话，这个测试就完全不一样了。</p>
<p><strong><em>class OrderStateTester…</em></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOrderSendsMailIfUnfilled</span><span class="params">()</span> </span>&#123;</div><div class="line">  Order order = <span class="keyword">new</span> Order(TALISKER, <span class="number">51</span>);</div><div class="line">  Mock warehouse = mock(Warehouse.class);</div><div class="line">  Mock mailer = mock(MailService.class);</div><div class="line">  order.setMailer((MailService) mailer.proxy());</div><div class="line"></div><div class="line">  mailer.expects(once()).method(<span class="string">"send"</span>);</div><div class="line">  warehouse.expects(once()).method(<span class="string">"hasInventory"</span>)</div><div class="line">    .withAnyArguments()</div><div class="line">    .will(returnValue(<span class="keyword">false</span>));</div><div class="line"></div><div class="line">  order.fill((Warehouse) warehouse.proxy());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在两个例子中，我都使用了double，而没用真实对象。一个不同是stub使用状态验证而mock使用了行为验证。</p>
<p>为了对stub使用状态验证，我需要给stub写额外的方法来完成验证。结果stub实现了<code>MailSerivce</code>，却也添加了额外的测试方法。</p>
<p>mock常使用行为验证，stub两种方法都可以。Meszaros将使用行为验证的stub称作<strong><em>测试间谍（Test Spy）</em></strong>。不同在于double如何运作和验证，我将把它留给你们自己来解释。</p>
<hr>
<p>之前一直不能完全理解stub和mock的不同，后来发现了这篇据说是权威解释的文章。于是把它的前半部分翻译了一下，帮助加深理解。文章后半部分中，作者针对传统测试与mock式测试进行比较与思考。</p>
<p>原文地址：<a href="http://martinfowler.com/articles/mocksArentStubs.html" target="_blank" rel="external">Mocks Aren’t Stubs</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/14/hexo使用记录/" itemprop="url">
                  hexo使用记录
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-14T15:05:10+08:00" content="2016-10-14">
              2016-10-14
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/14/hexo使用记录/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/14/hexo使用记录/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>Hexo</strong>是一个快速、简洁且高效的博客框架。Hexo使用<strong>Markdown</strong>（或其他渲染引擎）解析文章，它可以使用各种主题生成静态网页。可以用Hexo快速搭建博客，而不需要任何数据库和后台代码。一般会把Hexo部署在<strong>GitHub Pages</strong>上，如果想在国内更快的访问，可以搭建在<strong>Coding</strong>上，它同样提供了Pages服务。</p>
<h1 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h1><p>Hexo基本的安装、配置等说明在它的<a href="https://hexo.io/zh-cn/docs/" target="_blank" rel="external">官方文档</a>里都有说明，在此不再赘述。</p>
<h1 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h1><p>Hexo可以方便地更换<a href="https://hexo.io/themes/" target="_blank" rel="external">主题</a>。只需要将下载下来的主题放在hexo的<strong>themes</strong>文件夹内，并将根目录下的的<strong>_config.yml</strong>内的<strong>theme</strong>修改为对应的主题名称，即可切换主题。</p>
<p>在Hexo中有两份主要的配置文件，其名称都是<strong>_config.yml</strong>。其中，一份位于站点根目录下，主要包含Hexo本身的配置；另一份则位于主题目录下，主要用于配置主题相关的选项。可以将前者称为<strong>站点配置文件</strong>，后者称为<strong>主题配置文件</strong>。</p>
<h1 id="评论"><a href="#评论" class="headerlink" title="评论"></a>评论</h1><p><strong>添加评论</strong>是博客中常用的功能，在Hexo中通过集成第三方服务<a href="http://duoshuo.com/" target="_blank" rel="external"><strong>多说</strong></a>来添加评论。</p>
<ul>
<li>首先在多说登录后，在首页选择“我要安装”。</li>
<li>创建站点，填写站点相关信息。</li>
<li>完成后在<strong>站点配置文件</strong>中新增<strong><em>duoshuo_shortname</em></strong>字段，值设置为多说域名中填写的值。</li>
</ul>
<p>除了评论，还可以通过集成第三方服务，添加<strong>数据统计与分析</strong>、<strong>内容分享</strong>、<strong>搜索</strong>等服务。</p>
<h1 id="搜索引擎收录"><a href="#搜索引擎收录" class="headerlink" title="搜索引擎收录"></a>搜索引擎收录</h1><p>写了几篇博客之后，会发现自己的文字并不能被搜索引擎搜索到。这下不能装逼了，没关系，只需要让搜索引擎收录你的网页即可。</p>
<h2 id="网站验证"><a href="#网站验证" class="headerlink" title="网站验证"></a>网站验证</h2><p>百度和谷歌分别提供了<a href="http://zhanzhang.baidu.com/" target="_blank" rel="external">站长平台</a>和<a href="https://www.google.com/webmasters/tools/home?hl=zh-CN" target="_blank" rel="external"><strong>Google Search Console</strong></a>给用户管理自己的网站。</p>
<p>首先需要验证你对网站的所有权，以百度为例。</p>
<ul>
<li>首先，需要提交你的链接地址。</li>
<li>提交后，百度会要求验证，来证明你是该域名的拥有者，可以快捷批量添加子站点，查看所有子站的数据，无需再一一验证子站点。站长平台提供了三种验证方式：<strong>文件验证</strong>、<strong>html标签验证</strong>和<strong>CNAME验证</strong>。<ul>
<li>文件验证：下载验证文件，将其放置在域名根目录下，使其能被访问到。</li>
<li>html标签验证：将<strong><em>html</em></strong>标签添加至网站首页<strong><em>html</em></strong>代码的<strong><em><head></head></em></strong>标签与<strong><em></em></strong>标签之间。</li>
<li>CNAME验证：需要登录域名提供商或托管服务提供商的网站，添加新的DNS记录。</li>
</ul>
</li>
</ul>
<p>一般采用文件验证的方式，如果你的博客搭建在GitHub Pages上，你会发现验证无法通过。。因为百度无法访问国外地址。所以，可以选择将博客同时构建在GitHub和Coding上。</p>
<h2 id="同时托管到GitHub和Coding"><a href="#同时托管到GitHub和Coding" class="headerlink" title="同时托管到GitHub和Coding"></a>同时托管到GitHub和Coding</h2><h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><p>首先修改站点配置文件<strong>_config.yml</strong>中的deploy属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">deploy</div><div class="line">	type: git</div><div class="line">	repo:</div><div class="line">		github: &lt;repository url&gt;, [branch]</div><div class="line">		coding: &lt;repository url&gt;, [branch]</div></pre></td></tr></table></figure>
<p>这里要注意格式的缩进，否则会报错。提交方式用http和ssh都可，ssh避免了输入账号密码，它需要添加公钥，这方面的教程很多，就不多说了。。</p>
<h3 id="在Coding上创建新项目"><a href="#在Coding上创建新项目" class="headerlink" title="在Coding上创建新项目"></a>在Coding上创建新项目</h3><p>默认你已经把Hexo托管到了GitHub上了。。那么现在就要把他同时托管到Coding。部署博客的方式有两种，第一种是Pages服务的方式，第二种演示方式可以绑定自定义域名。这里我们选择第一种方式。</p>
<p>首先，在Coding上创建一个仓库，推荐名称和用户名一样，比如我的Coding用户名是huga，博客仓库名也是huga。这样访问<strong><em>huga.coding.me</em></strong>就能访问博客，否则需要带上项目名<strong><em>huga.coding.me/[项目名]</em></strong>。然后选择<strong>代码</strong>–<strong>Pages 服务</strong>，开启服务即可。</p>
<p><img src="/imgs/1.png" alt="Coding Pages"></p>
<p>接着，在博客<strong><em>source/</em></strong>目录下需要创建一个空白文件，名字必须是<strong><em>Staticfile</em></strong>。大概是因为Coding把这个文件作为静态部署的标志。</p>
<p>然后就可以用Hexo进行部署了，注意分支要和站点配置文件中写的一致。</p>
<p>至此，Coding和GitHub上托管的博客都可以访问了。</p>
<p>所以，现在要把百度站长平台上的链接改为Coding Pages的地址，重新验证就可以通过了。</p>
<h2 id="站点地图"><a href="#站点地图" class="headerlink" title="站点地图"></a>站点地图</h2><p>站点地图，又称网站地图，它是一个网站所有链接的容器。站点地图可以方便搜索引擎蜘蛛抓取网站页面，来清晰了解网站的架构。</p>
<p>首先使用以下命令进行安装生成谷歌和百度站点地图的插件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install hexo-generator-sitemap --save</div><div class="line">npm install hexo-generator-baidu-sitemap --save</div></pre></td></tr></table></figure>
<p>然后生成你的博客</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo g</div></pre></td></tr></table></figure>
<p>如果在<strong><em>public</em></strong>目录下生成了<strong><em>sitemap.xml</em></strong>和<strong><em>baidusitemap.xml</em></strong>，就说明成功了。<br>这时候可以打开这两个sitemap检查一下，如果<strong><em>baidusitemap.xml</em></strong>中的地址指向GitHub，那么需要把它改成Coding的博客地址，否则百度是爬取不到的。</p>
<p>然后在百度站长地图中进入你的站点，选择<strong>网页抓取</strong>——<strong>连接提交</strong>——<strong>自动提交</strong>——<strong>sitemap</strong>，填写你的sitemap地址，提交即可。</p>
<p><img src="/imgs/2.png" alt="百度提交站点地图"></p>
<p>通过站点地图，搜索引擎会定期爬取你的网站内容，所以需要及时更新你的站点地图。</p>
<p>除了站点地图，百度还提供了另外三种提交链接的方式：</p>
<ul>
<li>主动推送：将你的所有链接写入一个文本文件，然后通过curl、post等方式将这个文件推送给百度，能使新链接及时被百度收录。</li>
<li>自动推送：将自动推送的js代码放在每个页面中，当这些页面被访问时，就会自动推送给百度了。</li>
<li>手动提交：在站长平台页面上提交所有链接地址。</li>
</ul>
<h2 id="百度收录"><a href="#百度收录" class="headerlink" title="百度收录"></a>百度收录</h2><p>要被百度收录相对比较困难。。光提交站点地图可能很慢，所以可以选择上述主动提交的方式，参照站长平台上的说明。</p>
<p><img src="/imgs/3.png" alt="百度自动提交"></p>
<h2 id="谷歌收录"><a href="#谷歌收录" class="headerlink" title="谷歌收录"></a>谷歌收录</h2><p>谷歌比较方便，进入<a href="https://www.google.com/webmasters/tools/home?hl=zh-CN" target="_blank" rel="external"><strong><em>Google Search Console</em></strong></a>，添加站点，通过验证后进入站点，选择<strong>抓取</strong>——<strong>站点地图</strong>——<strong>添加/测试站点地图</strong>。</p>
<p><img src="/imgs/4.png" alt="谷歌添加站点地图"></p>
<p>提交过后一两天，谷歌就可以搜索到我的博客了，还是很快的。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Hexo搭建博客十分方便，还可以继承各种第三方服务，但是为了装逼，想被搜索引擎搜索到的话，就需要给百度、谷歌收录，还需要同时部署到GitHub和Coding上。另外，百度收录真的很慢。。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://www.jianshu.com/p/619dab2d3c08" target="_blank" rel="external">hexo干货系列：（六）hexo提交搜索引擎（百度+谷歌）</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/20/AFNetworking3的基本使用/" itemprop="url">
                  AFNetworking3的基本使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-20T11:03:26+08:00" content="2016-09-20">
              2016-09-20
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/20/AFNetworking3的基本使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/20/AFNetworking3的基本使用/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>AFNetworking</strong>一直是iOS和Mac OS X上最热门的网络库。之前一直用的是2.x版本，前不久更新了3才发现原来的代码一堆错。原来为了配合iOS7网络接口的调整，AFN3.x取消了<strong><em>AFHTTPRequestOperationManager</em></strong>及相关的类，取而代之的是<strong><em>AFURLSessionManager</em></strong>。如果为了兼容iOS 6、Mac OS X 10.8或更低版本，你仍然可以选择AFHTTPRequestOperationManager。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>最方便的就是用<strong>CocoaPods</strong>了，在Podfile中加入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pod &apos;AFNetworking&apos;, &apos;~&gt; 3.0&apos;</div></pre></td></tr></table></figure>
<h1 id="创建manger"><a href="#创建manger" class="headerlink" title="创建manger"></a>创建manger</h1><p>苹果的文档中推荐开发者通过继承AFHTTPSessionManager来提供一些通用的配置，在整个应用中可以共享一个单例。这样就避免了在每次发送http请求时进行三次握手，一定程度上提高了效率。</p>
<p>如果访问的服务器是同一个，可以用baseURL来初始化，这样发送请求时只需要相对url。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AFHTTPSessionManager *manager = [[AFHTTPSessionManager alloc] initWithBaseURL:[<span class="built_in">NSURL</span> URLWithString:BASE_URL]];</div></pre></td></tr></table></figure>
<p>也可以用配置对象来初始化</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSURLSessionConfiguration</span> *configuration = [<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];</div><div class="line">AFHTTPSessionManager *manager = [[AFHTTPSessionManager alloc] initWithSessionConfiguration:configuration];</div></pre></td></tr></table></figure>
<h1 id="配置Serializer"><a href="#配置Serializer" class="headerlink" title="配置Serializer"></a>配置Serializer</h1><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 设置请求数据格式</span></div><div class="line">manager.requestSerializer = [AFJSONRequestSerializer serializer];</div><div class="line"><span class="comment">// 设置请求超时时间</span></div><div class="line">manager.requestSerializer.timeoutInterval = <span class="number">15</span>;</div><div class="line"></div><div class="line"><span class="comment">// 设置相应数据格式</span></div><div class="line">manager.responseSerializer = [AFJSONResponseSerializer serializer];</div><div class="line"><span class="comment">// 如果得不到相应数据，可能是可接受的数据类型不匹配</span></div><div class="line">manager.responseSerializer.acceptableContentTypes = [<span class="built_in">NSSet</span> setWithObjects:<span class="string">@"application/json"</span>, <span class="string">@"text/html"</span>, <span class="literal">nil</span>];</div></pre></td></tr></table></figure>
<h1 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h1><ul>
<li>GET</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[manager GET:<span class="string">@"url/string"</span> </div><div class="line">  parameters:@&#123;<span class="string">@"key"</span>:<span class="string">@"value"</span>&#125; </div><div class="line">    progress:^(<span class="built_in">NSProgress</span> * _Nonnull downloadProgress) &#123;</div><div class="line">		<span class="built_in">NSLog</span>(<span class="string">@"%f"</span>, uploadProgress.completedUnitCount / uploadProgress.totalUnitCount * <span class="number">1.0</span>);</div><div class="line">    &#125;</div><div class="line">     success:^(<span class="built_in">NSURLSessionDataTask</span> * _Nonnull task, <span class="keyword">id</span>  _Nullable responseObject) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, responseObject);</div><div class="line">&#125; </div><div class="line">     failure:^(<span class="built_in">NSURLSessionDataTask</span> * _Nullable task, <span class="built_in">NSError</span> * _Nonnull error) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, error);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<ul>
<li>POST</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[manager POST:<span class="string">@"url/string"</span> </div><div class="line">  parameters:@&#123;<span class="string">@"key"</span>:<span class="string">@"value"</span>&#125; </div><div class="line">    progress:^(<span class="built_in">NSProgress</span> * _Nonnull downloadProgress) &#123;</div><div class="line">		<span class="built_in">NSLog</span>(<span class="string">@"%f"</span>, uploadProgress.completedUnitCount / uploadProgress.totalUnitCount * <span class="number">1.0</span>);</div><div class="line">    &#125;</div><div class="line">     success:^(<span class="built_in">NSURLSessionDataTask</span> * _Nonnull task, <span class="keyword">id</span>  _Nullable responseObject) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, responseObject);</div><div class="line">&#125; </div><div class="line">     failure:^(<span class="built_in">NSURLSessionDataTask</span> * _Nullable task, <span class="built_in">NSError</span> * _Nonnull error) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, error);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<ul>
<li>下载</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSURL</span> *URL = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://example.com/download.zip"</span>];</div><div class="line"><span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:URL];</div><div class="line"></div><div class="line"><span class="built_in">NSURLSessionDownloadTask</span> *downloadTask = [manager downloadTaskWithRequest:request progress:^(<span class="built_in">NSProgress</span> * _Nonnull downloadProgress) &#123;</div><div class="line">		<span class="built_in">NSLog</span>(<span class="string">@"%f"</span>, uploadProgress.completedUnitCount / uploadProgress.totalUnitCount * <span class="number">1.0</span>);</div><div class="line">    &#125; destination:^<span class="built_in">NSURL</span> *(<span class="built_in">NSURL</span> *targetPath, <span class="built_in">NSURLResponse</span> *response) &#123;</div><div class="line">    	<span class="keyword">return</span> [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"path/to/save/to"</span>];</div><div class="line">&#125; completionHandler:^(<span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSURL</span> *filePath, <span class="built_in">NSError</span> *error) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"File downloaded to: %@"</span>, filePath);</div><div class="line">&#125;];</div><div class="line">[downloadTask resume];</div></pre></td></tr></table></figure>
<ul>
<li>上传</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[manager POST:<span class="string">@"url/string"</span> parameters:<span class="literal">nil</span> constructingBodyWithBlock:^(<span class="keyword">id</span>&lt;AFMultipartFormData&gt;  _Nonnull formData) &#123;</div><div class="line">    [formData appendPartWithFileURL:[<span class="built_in">NSURL</span> fileURLWithPath:<span class="string">@"file://path/to/image.jpg"</span>] name:<span class="string">@"file"</span> fileName:<span class="string">@"filename.jpg"</span> mimeType:<span class="string">@"image/jpeg"</span> error:<span class="literal">nil</span>];</div><div class="line">&#125; progress:^(<span class="built_in">NSProgress</span> * _Nonnull uploadProgress) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%f"</span>, uploadProgress.completedUnitCount / uploadProgress.totalUnitCount * <span class="number">1.0</span>);</div><div class="line">&#125; success:^(<span class="built_in">NSURLSessionDataTask</span> * _Nonnull task, <span class="keyword">id</span>  _Nullable responseObject) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, responseObject);</div><div class="line">&#125; failure:^(<span class="built_in">NSURLSessionDataTask</span> * _Nullable task, <span class="built_in">NSError</span> * _Nonnull error) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, error);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>也可以使用<strong>NSURLSessionUploadTask</strong>上传，它还支持后台上传：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSURL</span> *URL = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://example.com/upload"</span>];</div><div class="line"><span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:URL];</div><div class="line"></div><div class="line"><span class="built_in">NSURL</span> *filePath = [<span class="built_in">NSURL</span> fileURLWithPath:<span class="string">@"file://path/to/image.png"</span>];</div><div class="line"><span class="built_in">NSURLSessionUploadTask</span> *uploadTask = [manager uploadTaskWithRequest:request fromFile:filePath progress:<span class="literal">nil</span> completionHandler:^(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error) &#123;</div><div class="line">    <span class="keyword">if</span> (error) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Error: %@"</span>, error);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Success: %@ %@"</span>, response, responseObject);</div><div class="line">    &#125;</div><div class="line">&#125;];</div><div class="line">[uploadTask resume];</div></pre></td></tr></table></figure>
<h1 id="NetworkActivityIndicator"><a href="#NetworkActivityIndicator" class="headerlink" title="NetworkActivityIndicator"></a>NetworkActivityIndicator</h1><p>AFNetworking提供了在网络请求繁忙时，在状态栏显示小菊花的功能。这个功能默认是关闭的，需要手动打开：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[AFNetworkActivityIndicatorManager sharedManager].enabled = <span class="literal">YES</span>;</div></pre></td></tr></table></figure>
<p>需要导入包：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"AFNetworkActivityIndicatorManager.h"</span></span></div></pre></td></tr></table></figure>
<h1 id="监测网络状态"><a href="#监测网络状态" class="headerlink" title="监测网络状态"></a>监测网络状态</h1><p><strong>AFNetworkReachabilityManager</strong>提供了一个单例对象来监测网络，共有四种状态，分别是未知、没有网络连接、WWAN连接、WiFi连接：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, AFNetworkReachabilityStatus) &#123;</div><div class="line">    AFNetworkReachabilityStatusUnknown          = <span class="number">-1</span>,</div><div class="line">    AFNetworkReachabilityStatusNotReachable     = <span class="number">0</span>,</div><div class="line">    AFNetworkReachabilityStatusReachableViaWWAN = <span class="number">1</span>,</div><div class="line">    AFNetworkReachabilityStatusReachableViaWiFi = <span class="number">2</span>,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[[AFNetworkReachabilityManager sharedManager] setReachabilityStatusChangeBlock:^(AFNetworkReachabilityStatus status) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Reachability: %@"</span>, AFStringFromNetworkReachabilityStatus(status));</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[[AFNetworkReachabilityManager sharedManager] startMonitoring];</div></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>跟上一个版本相比，AFN3最大的变化就是<strong>AFHTTPRequestOperationManager</strong>没有了，换成了<strong>AFURLSessionManager</strong>。</p>
<p>这些只是AFN3中最基本的用法，还有更多强大的功能，共同学习！</p>
<p>最后附上AFN的<a href="https://github.com/AFNetworking/AFNetworking/" target="_blank" rel="external">GitHub地址</a>。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="黄嘉伟" />
          <p class="site-author-name" itemprop="name">黄嘉伟</p>
          <p class="site-description motion-element" itemprop="description">程序猿二三事</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">4</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">黄嘉伟</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"huangjiawei"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
